---
title: "linear forest Covid-19"
author: "Marlin"
date: "2023-01-04"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r data prep}
library(DSIWastewater)
library(dplyr)
library(ggplot2)
library(tidyr)
data(WasteWater_data, package = "DSIWastewater")
data(Case_data, package = "DSIWastewater")
data(pop_data, package = "DSIWastewater")

base_df <- inner_join(Case_data, WasteWater_data, by = c("site", "date"))%>%
  left_join(pop_data)%>%
  group_by(site)%>%
  arrange(date)%>%
  mutate(conf_case = zoo::rollmean(conf_case, 7, align = "center", na.pad = TRUE))%>%
  ungroup()%>%
  select(conf_case, N1, N2,
         regions, date, pop,
         PMMoV, flow,
         conductivity, temperature, ph, tests)%>%
   mutate(regions = factor(regions), date = as.numeric(date),
         conf_case = log(conf_case),
         N1 = log(N1),
         N2 = log(N2),
         PMMoV = log(PMMoV))
#conductivity, temperature, ph, tests

base_df%>%
  dplyr::summarise(across(everything(), function(x) sum(is.na(x))))

model_data <- base_df%>%
   filter(if_all(everything(), is.finite))
```


```{r linear forest funcs}
library(rsample)
library(purrr)
library(partykit)
library(sandwich)
```


```{r tree tools}

MSE <- function(true, pred){
  mean((true - pred)**2, na.rm = TRUE)
}
```

```{r modeling}
train_df <- model_data%>%
  slice_sample(prop = 0.70)

test_df  <- model_data%>%
  anti_join(train_df)

form <- conf_case ~ N1 + N2 | . - N1 - N2
#form <- conf_case ~ N1 | . - N1 - N2
forest_model <- random_linear_forest(train_df, 500, 
                                     form, max_depth = 3)



#benchmark(random_linear_forest(train_df, 5, 
#                                     form, maxdepth = 3),
#               times = 10)
#library( rbenchmark)

MSE(predict(forest_model, test_df), test_df$conf_case)

#look into pred being conservitive
test_df%>%
  ggplot(aes(x = conf_case, 
             y = conf_case - predict(forest_model, test_df)))+
  geom_point()


#get better viz tools
#compare tree vs linear tree
#viz 1 tree -> viz forest
#forest viz
forest_model@models[[1]]
library(plyr)
library(dplyr)
gen_INCMSE(forest_model)
```

```{r lm model}
lm_model <- lm(conf_case ~ N1 + N2, data = train_df)
MSE(predict(lm_model, test_df), test_df$conf_case)

test_df%>%
  ggplot(aes(x = conf_case, y = conf_case - predict(lm_model, test_df)))+
  geom_point()
```


```{r testing}
temp <- OOB_MSE_num_trees(forest_model)

temp%>%
  ggplot(aes(y = model_MSE, x = num_tree))+
  geom_line()
```


```{r graph lm_tree}

library(plotly)

plot_lmTree <- function(lmtree_obj){
  plot(lmtree_obj)
  nodes <- as.character(c(3:4,6:7))
  point_plot <- data.frame()
  mx_model <- data.frame()
  for(i in 1:length(nodes)){
    indx <- nodes[i]
    new_data <- data_party(lmtree_obj[[as.numeric(indx)]])%>%
      mutate(model = indx)
    ###
    new_model <- coef(lmtree_obj[[as.numeric(indx)]])%>%
      as.data.frame()%>%
      transpose()%>%
      as.data.frame()
    names(new_model) <- c("intercept", "N1", "N2")
    mx_model <- new_model%>%
      mutate(model = indx)%>%
      mutate(intercept = intercept + mean(new_data$N2, na.rm = TRUE)* N2)%>%
      bind_rows(mx_model)
    
    ####
    point_plot <- new_data%>%
      bind_rows(point_plot)
  }
  tree_plot <- ggplot() + 
    geom_point(data = point_plot, aes(x = N1, y = conf_case,
                                      color = model))+
    geom_abline(data = mx_model,
                aes(intercept = intercept,
                    slope = N1,
                    color = model))
  return(tree_plot)
}
lapply(1:5, function(x) ggplotly(plot_lmTree(forest_model@models[[x]])))
#ggplotly(plot_lmTree(forest_model@models[[4]]))
```

```{r temp}
plot_lmTree <- function(lmtree_obj){
  plot(lmtree_obj)
  nodes <- as.character(c(3:4,6:7))
  point_plot <- data.frame()
  mx_model <- data.frame()
  for(i in 1:length(nodes)){
    indx <- nodes[i]
    new_data <- data_party(lmtree_obj[[as.numeric(indx)]])%>%
      mutate(model = indx)
    ###
    new_model <- coef(lmtree_obj[[as.numeric(indx)]])%>%
      as.data.frame()%>%
      transpose()%>%
      as.data.frame()
    names(new_model) <- c("intercept", "N1", "N2")
    mx_model <- new_model%>%
      mutate(model = indx)%>%
      bind_rows(mx_model)
    
    ####
    point_plot <- new_data%>%
      mutate(conf_case = conf_case - N2 * new_model$N2)%>%
      bind_rows(point_plot)
  }
  tree_plot <- ggplot() + 
    geom_point(data = point_plot, aes(x = N1, y = conf_case,
                                      color = model))+
    geom_abline(data = mx_model,
                aes(intercept = intercept,
                    slope = N1,
                    color = model))
  return(tree_plot)
}
lapply(1:5, function(x) ggplotly(plot_lmTree(forest_model@models[[x]])))

```


